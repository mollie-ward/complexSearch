name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, 'copilot/**' ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  backend-tests:
    name: Backend Tests & Coverage
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: Restore dependencies
        run: |
          cd src
          dotnet restore VehicleSearch.slnx
      
      - name: Build
        run: |
          cd src
          dotnet build VehicleSearch.slnx --no-restore --configuration Release
      
      - name: Run unit tests with coverage
        run: |
          cd src
          dotnet test VehicleSearch.slnx \
            --no-build \
            --configuration Release \
            --collect:"XPlat Code Coverage" \
            --results-directory ../test-results/backend \
            --logger "trx;LogFileName=backend-test-results.trx"
      
      - name: Generate coverage report
        uses: danielpalme/ReportGenerator-GitHub-Action@5.3.11
        with:
          reports: '**/coverage.cobertura.xml'
          targetdir: 'coverage-report/backend'
          reporttypes: 'HtmlInline;Cobertura;MarkdownSummary'
      
      - name: Check coverage threshold
        run: |
          # Extract coverage percentage from Cobertura XML using Python
          python3 << 'EOF'
          import xml.etree.ElementTree as ET
          import sys
          
          try:
              tree = ET.parse('coverage-report/backend/Cobertura.xml')
              root = tree.getroot()
              line_rate = float(root.get('line-rate', 0))
              coverage_percent = line_rate * 100
              
              print(f"Backend Coverage: {coverage_percent:.2f}%")
              
              # Enforce 85% coverage threshold
              if coverage_percent < 85:
                  print(f"âŒ Coverage {coverage_percent:.2f}% is below 85% threshold")
                  sys.exit(1)
              
              print(f"âœ… Coverage {coverage_percent:.2f}% meets 85% threshold")
          except Exception as e:
              print(f"Warning: Could not parse coverage file: {e}")
              print("Skipping coverage threshold check")
          EOF
      
      - name: Upload backend test results
        uses: actions/upload-artifact@v4.5.0
        if: always()
        with:
          name: backend-test-results
          path: |
            test-results/backend
            coverage-report/backend
      
      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: 'test-results/backend/*.trx'
          check_name: 'Backend Test Results'
  
  frontend-tests:
    name: Frontend Tests & Coverage
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Run linter
        run: |
          cd frontend
          npm run lint || true
      
      - name: Run tests with coverage
        run: |
          cd frontend
          npm test -- --coverage --watchAll=false --ci
        env:
          CI: true
      
      - name: Check coverage threshold
        run: |
          cd frontend
          # Extract coverage from coverage-summary.json using Python
          python3 << 'EOF'
          import json
          import sys
          
          try:
              with open('coverage/coverage-summary.json', 'r') as f:
                  summary = json.load(f)
              
              coverage = summary['total']['lines']['pct']
              print(f"Frontend Coverage: {coverage}%")
              
              # Enforce 80% coverage threshold
              if coverage < 80:
                  print(f"âŒ Coverage {coverage}% is below 80% threshold")
                  sys.exit(1)
              
              print(f"âœ… Coverage {coverage}% meets 80% threshold")
          except Exception as e:
              print(f"Warning: Could not parse coverage file: {e}")
              print("Skipping coverage threshold check")
          EOF
      
      - name: Upload frontend test results
        uses: actions/upload-artifact@v4.5.0
        if: always()
        with:
          name: frontend-test-results
          path: |
            frontend/coverage
            frontend/test-results
  
  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, mobile]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: Install root dependencies
        run: npm ci
      
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}
      
      - name: Build frontend
        run: |
          cd frontend
          npm run build
      
      - name: Run E2E tests
        run: npm run test:e2e -- --project=${{ matrix.browser }}
        env:
          CI: true
      
      - name: Upload Playwright report
        uses: actions/upload-artifact@v4.5.0
        if: always()
        with:
          name: playwright-report-${{ matrix.browser }}
          path: |
            playwright-report/
            test-results/
          retention-days: 30
      
      - name: Upload test artifacts
        uses: actions/upload-artifact@v4.5.0
        if: failure()
        with:
          name: playwright-artifacts-${{ matrix.browser }}
          path: |
            playwright-report/
            test-results/
            screenshots/
            videos/
  
  coverage-upload:
    name: Upload Coverage to Codecov
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download backend coverage
        uses: actions/download-artifact@v4.1.8
        with:
          name: backend-test-results
          path: coverage/backend
      
      - name: Download frontend coverage
        uses: actions/download-artifact@v4.1.8
        with:
          name: frontend-test-results
          path: coverage/frontend
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: |
            coverage/backend/Cobertura.xml
            coverage/frontend/coverage/coverage-final.json
          flags: backend,frontend
          name: codecov-complexsearch
          fail_ci_if_error: false
      
      - name: Comment PR with coverage
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            
            // Read backend coverage summary
            const backendSummary = fs.readFileSync('coverage/backend/Summary.md', 'utf8');
            
            // Read frontend coverage (simplified)
            let frontendCoverage = 'N/A';
            try {
              const frontendSummaryPath = 'coverage/frontend/coverage/coverage-summary.json';
              if (fs.existsSync(frontendSummaryPath)) {
                const summary = JSON.parse(fs.readFileSync(frontendSummaryPath, 'utf8'));
                frontendCoverage = `${summary.total.lines.pct}%`;
              }
            } catch (e) {
              console.log('Could not read frontend coverage');
            }
            
            const body = `## ðŸ“Š Code Coverage Report
            
            ### Backend Coverage
            ${backendSummary}
            
            ### Frontend Coverage
            **Line Coverage:** ${frontendCoverage}
            
            ---
            *Coverage thresholds: Backend â‰¥85%, Frontend â‰¥80%*
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
  
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: Restore dependencies
        run: |
          cd tests/VehicleSearch.Integration.Tests
          dotnet restore
      
      - name: Build
        run: |
          cd tests/VehicleSearch.Integration.Tests
          dotnet build --no-restore --configuration Release
      
      - name: Run integration tests
        run: |
          cd tests/VehicleSearch.Integration.Tests
          dotnet test --no-build --configuration Release --logger "trx;LogFileName=integration-test-results.trx"
      
      - name: Upload integration test results
        uses: actions/upload-artifact@v4.5.0
        if: always()
        with:
          name: integration-test-results
          path: tests/VehicleSearch.Integration.Tests/TestResults
  
  build-status:
    name: Build Status Check
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, e2e-tests, integration-tests]
    if: always()
    
    steps:
      - name: Check all jobs
        run: |
          echo "Backend Tests: ${{ needs.backend-tests.result }}"
          echo "Frontend Tests: ${{ needs.frontend-tests.result }}"
          echo "E2E Tests: ${{ needs.e2e-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          
          if [[ "${{ needs.backend-tests.result }}" != "success" ]] || \
             [[ "${{ needs.frontend-tests.result }}" != "success" ]] || \
             [[ "${{ needs.e2e-tests.result }}" != "success" ]] || \
             [[ "${{ needs.integration-tests.result }}" != "success" ]]; then
            echo "âŒ One or more test jobs failed"
            exit 1
          fi
          
          echo "âœ… All tests passed!"
      
      - name: Post summary
        run: |
          echo "## âœ… All Tests Passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Backend Tests" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Frontend Tests" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… E2E Tests (Chrome, Firefox, Mobile)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ready for deployment! ðŸš€**" >> $GITHUB_STEP_SUMMARY
